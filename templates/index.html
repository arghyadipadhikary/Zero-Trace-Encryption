<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZERO-TRACE // E2EE</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link rel="apple-touch-icon" href="/static/favicon.ico">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    },
                    colors: {
                        cyber: '#6366f1', 
                        burn: '#f97316',  
                        dark: '#0f172a'   
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background: radial-gradient(circle at top right, #1e1b4b, #0f172a);
            color: #e2e8f0;
        }
        .glass {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .cyber-glow:hover {
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
            border-color: rgba(99, 102, 241, 0.6);
        }
        
        body::before {
            content: " ";
            display: block;
            position: fixed;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02));
            z-index: 100;
            background-size: 100% 4px, 3px 100%;
            pointer-events: none;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6 font-sans">

    <div class="fixed top-0 left-0 w-full p-6 flex justify-between items-center pointer-events-none z-50">
        <div class="font-mono text-[10px] tracking-[0.2em] text-cyber opacity-70">
            SYSTEM_STATUS: <span class="text-green-400">ENCRYPTED_IDLE</span>
        </div>
        
        <div class="pointer-events-auto flex items-center space-x-3 glass p-2 px-4 rounded-full">
            <span class="font-mono text-[9px] font-bold text-gray-400 uppercase tracking-widest">Protocol: Burn</span>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="burnToggle" class="sr-only peer">
                <div class="w-9 h-5 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-burn"></div>
            </label>
        </div>
    </div>

    <div class="glass rounded-3xl w-full max-w-lg overflow-hidden shadow-2xl relative">
        <div class="bg-white/5 border-b border-white/10 p-4 px-8 flex justify-between items-center">
            <div class="flex space-x-2">
                <div class="w-3 h-3 rounded-full bg-red-500/50"></div>
                <div class="w-3 h-3 rounded-full bg-yellow-500/50"></div>
                <div class="w-3 h-3 rounded-full bg-green-500/50"></div>
            </div>
            <div class="font-mono text-xs text-gray-400 uppercase tracking-tighter">Secure_Tunnel_v1.0</div>
        </div>

        <div class="p-10">
            <div class="text-center mb-10">
                <h2 class="text-3xl font-extrabold tracking-tighter text-white mb-2 underline decoration-cyber">ZERO-TRACE</h2>
                <p class="text-xs font-mono text-cyber opacity-80 uppercase tracking-widest italic">Zero-Knowledge Transmission</p>
            </div>

            <div id="uploadBox" class="space-y-6">
                <div id="dropZone" class="group border-2 border-dashed border-white/10 rounded-2xl p-10 text-center cursor-pointer hover:border-cyber/50 hover:bg-cyber/5 transition-all duration-500 relative overflow-hidden" onclick="document.getElementById('fileInput').click()">
                    <div class="relative z-10">
                        <i class="fa-solid fa-terminal text-3xl text-cyber mb-4 group-hover:scale-110 transition-transform"></i>
                        <p class="text-gray-300 font-medium tracking-tight">DROP_FILE_HERE</p>
                        <p class="text-[10px] font-mono text-gray-500 mt-2 uppercase tracking-tighter">Limit: 650MB // AES-256-GCM</p>
                    </div>
                    <input type="file" id="fileInput" class="hidden" onchange="handleFileSelect()">
                </div>

                <div id="fileInfo" class="hidden glass bg-white/5 p-4 rounded-xl flex justify-between items-center border border-white/10">
                    <div class="flex items-center truncate">
                        <i class="fa-solid fa-code text-cyber mr-3"></i>
                        <span id="fileNameDisplay" class="text-xs font-mono text-gray-300 truncate"></span>
                    </div>
                    <button onclick="clearSelection()" class="text-gray-500 hover:text-red-400 transition-colors px-2">
                        <i class="fa-solid fa-circle-xmark"></i>
                    </button>
                </div>

                <button id="uploadBtn" onclick="handleUpload()" class="hidden w-full bg-cyber hover:bg-indigo-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg hover:shadow-indigo-500/20 active:scale-95 uppercase tracking-widest text-xs">
                    Initiate Encryption
                </button>

                <div id="progressContainer" class="hidden space-y-3">
                    <div class="flex justify-between font-mono text-[10px] text-cyber tracking-widest">
                        <span id="uploadStatus">PROCESSING...</span>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="w-full bg-white/5 rounded-full h-1 overflow-hidden">
                        <div id="progressBarFill" class="bg-cyber h-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>

                <div id="linkContainer" class="hidden space-y-4">
                    <div class="p-4 bg-green-500/10 border border-green-500/20 rounded-xl">
                        <p id="uploadSuccessHeader" class="text-[10px] font-mono font-bold text-green-400 uppercase tracking-widest mb-3">
                            <i class="fa-solid fa-lock mr-2"></i>Link_Generated_Successfully
                        </p>
                        <div class="flex items-center bg-black/40 rounded-lg p-3 border border-white/5">
                            <input type="text" id="shareLinkInput" readonly class="w-full text-xs font-mono text-gray-400 outline-none bg-transparent truncate">
                            <button onclick="copyLink()" class="ml-3 text-cyber hover:text-white transition-colors" title="Copy">
                                <i class="fa-solid fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="downloadBox" class="hidden text-center space-y-8">
                <div class="relative inline-block">
                    <div class="absolute inset-0 bg-cyber rounded-full blur-2xl opacity-20"></div>
                    <i class="fa-solid fa-vault text-6xl text-cyber relative"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-white tracking-tight">ENCRYPTED_ASSET_DETECTED</h3>
                    <p class="text-xs font-mono text-gray-500 mt-2 uppercase">Decryption key verified in fragment hash</p>
                </div>
                
                <button id="downloadBtn" onclick="handleDownload()" class="w-full bg-cyber hover:bg-indigo-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg uppercase tracking-widest text-xs">
                    Authorize Decryption
                </button>
                <p id="downloadStatus" class="font-mono text-[10px] text-cyber uppercase tracking-widest"></p>
            </div>
        </div>

        <div class="bg-white/5 p-3 text-center border-t border-white/10">
            <span class="text-[8px] font-mono text-gray-600 tracking-[0.4em] uppercase">
                Private_Node_Protocol // <span id="sessionHex" class="text-cyber">0x6432</span>
            </span>
        </div>
    </div>

    <div class="fixed bottom-6 w-full text-center pointer-events-none z-50">
        <p class="font-mono text-[10px] uppercase tracking-[0.3em] text-gray-600 opacity-50">
            powered by <span class="text-cyber font-bold pointer-events-auto">Arghyadip@01</span> &copy; 2026
        </p>
    </div>

    <script>
        const CHUNK_SIZE = 64 * 1024; 
        const bufferToBase64 = (buf) => btoa(String.fromCharCode(...new Uint8Array(buf)));
        const base64ToBuffer = (b64) => Uint8Array.from(atob(b64), c => c.charCodeAt(0));

        let selectedFile = null;
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        
        function generateSessionHex() {
            const hex = Math.floor(Math.random() * 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
            document.getElementById('sessionHex').innerText = `0x${hex}`;
        }

        function handleFileSelect() {
            if (fileInput.files.length > 0) {
                selectedFile = fileInput.files[0];
                document.getElementById('dropZone').classList.add('hidden');
                document.getElementById('fileInfo').classList.remove('hidden');
                document.getElementById('fileNameDisplay').innerText = selectedFile.name;
                document.getElementById('uploadBtn').classList.remove('hidden');
            }
        }

        function clearSelection() {
            fileInput.value = ''; selectedFile = null;
            document.getElementById('dropZone').classList.remove('hidden');
            document.getElementById('fileInfo').classList.add('hidden');
            document.getElementById('uploadBtn').classList.add('hidden');
            document.getElementById('linkContainer').classList.add('hidden');
        }

        function copyLink() {
            const linkInput = document.getElementById('shareLinkInput');
            linkInput.select();
            document.execCommand("copy");
            alert("LINK_COPIED_TO_CLIPBOARD");
        }

        async function handleUpload() {
            if (!selectedFile) return;
            const burnActive = document.getElementById('burnToggle').checked;

            document.getElementById('uploadBtn').classList.add('hidden');
            document.getElementById('progressContainer').classList.remove('hidden');
            const status = document.getElementById('uploadStatus');
            const progressBarFill = document.getElementById('progressBarFill');
            const progressText = document.getElementById('progressText');

            status.innerText = "LOCAL_ENCRYPTING...";
            
            const key = await crypto.subtle.generateKey({ name: 'AES-GCM', length: 256 }, true, ['encrypt']);
            const exportedKey = await crypto.subtle.exportKey('raw', key);
            const base64Key = bufferToBase64(exportedKey);

            let iv = crypto.getRandomValues(new Uint8Array(12));
            const encryptedBlobs = [new Blob([iv])]; 

            progressBarFill.style.width = '15%';

            for (let offset = 0; offset < selectedFile.size; offset += CHUNK_SIZE) {
                const chunk = await selectedFile.slice(offset, offset + CHUNK_SIZE).arrayBuffer();
                const encryptedChunk = await crypto.subtle.encrypt({ name: 'AES-GCM', iv: iv }, key, chunk);
                encryptedBlobs.push(new Blob([encryptedChunk]));
                iv = new Uint8Array(encryptedChunk).slice(-12); 
            }

            const finalPayload = new Blob(encryptedBlobs);
            status.innerText = "UPLOADING_TUNNEL...";

            const formData = new FormData();
            formData.append("file", finalPayload, "encrypted.bin");

            const xhr = new XMLHttpRequest();
            xhr.open("POST", `/upload?burn=${burnActive}`, true);

            xhr.upload.onprogress = (event) => {
                if (event.lengthComputable) {
                    const percent = Math.round((event.loaded / event.total) * 100);
                    progressBarFill.style.width = Math.max(15, percent) + '%';
                    progressText.innerText = Math.max(15, percent) + '%';
                }
            };

            xhr.onload = () => {
                if (xhr.status === 200) {
                    const data = JSON.parse(xhr.responseText);
                    const shareUrl = `${window.location.origin}/#${data.fileId}|${base64Key}|${encodeURIComponent(selectedFile.name)}`;
                    document.getElementById('progressContainer').classList.add('hidden');
                    document.getElementById('linkContainer').classList.remove('hidden');
                    document.getElementById('shareLinkInput').value = shareUrl;
                    if(data.burned) {
                        document.getElementById('uploadSuccessHeader').innerHTML = '<i class="fa-solid fa-fire text-burn mr-1"></i> protocol_burn_enabled';
                        document.getElementById('uploadSuccessHeader').classList.add('text-burn');
                    }
                } else {
                    status.innerText = "UPLOAD_CRITICAL_FAILURE";
                    progressBarFill.classList.add('bg-red-500');
                }
            };
            xhr.send(formData);
        }

        async function handleDownload() {
            const status = document.getElementById('downloadStatus');
            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.disabled = true;
            status.innerText = "AUTHORIZING...";
            
            try {
                const hashData = window.location.hash.substring(1).split('|');
                const fileId = hashData[0];
                const base64Key = hashData[1];
                const originalName = decodeURIComponent(hashData[2]);

                const response = await fetch(`/download/${fileId}`);
                if (!response.ok) throw new Error("LINK_EXPIRED_OR_DESTROYED");
                const encryptedPayload = await response.arrayBuffer();

                status.innerText = "LOCAL_DECRYPTING...";
                const rawKey = base64ToBuffer(base64Key);
                const key = await crypto.subtle.importKey('raw', rawKey, { name: 'AES-GCM' }, true, ['decrypt']);

                let iv = new Uint8Array(encryptedPayload, 0, 12);
                let offset = 12;
                const decryptedChunks = [];
                const cipherChunkSize = CHUNK_SIZE + 16; 

                while (offset < encryptedPayload.byteLength) {
                    const end = Math.min(offset + cipherChunkSize, encryptedPayload.byteLength);
                    const chunk = encryptedPayload.slice(offset, end);
                    const decryptedChunk = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: iv }, key, chunk);
                    decryptedChunks.push(new Blob([decryptedChunk]));
                    iv = new Uint8Array(chunk).slice(-12);
                    offset = end;
                }

                const blob = new Blob(decryptedChunks);
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = originalName; a.click();
                
                status.innerHTML = '<span class="text-green-400">DECRYPTION_SUCCESS</span>';
                downloadBtn.style.display = 'none';
            } catch (error) {
                status.innerHTML = `<span class="text-red-500">${error.message}</span>`;
                downloadBtn.disabled = false;
            }
        }

        window.onload = () => {
            generateSessionHex(); 
            if (window.location.hash.includes('|')) {
                document.getElementById('uploadBox').classList.add('hidden');
                document.getElementById('downloadBox').classList.remove('hidden');
            }
        };
    </script>
</body>
</html>
